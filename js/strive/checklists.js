jQuery((function($){function t(t,e=null){var n=t.attr("data-status"),i=t.attr("data-checklist");let s=0;t.parent().find(".task").each((function(){var t=parseInt($(this).attr("data-key"));s<=t&&(s=t+1)}));var a=$('<div class="task" data-key="'+s+'"></div>');a.append($('<input type="text" class="instructions-input" name="task-instructions" value="" />'));let c=Math.round(Math.random()*36**12).toString(36);a.append('<input type="hidden" class="id-input" name="task-id" value="'+c+'" />'),a.append('<input type="hidden" class="save-input" id="strive_post_checklists['+i+"][checklist]["+n+"]["+s+']" name="strive_post_checklists['+i+"][checklist]["+n+"]["+s+']" value="" />'),a.append($('<a class="remove-item"><span class="dashicons dashicons-dismiss"></span></a>')),a.append($('<img class="drag-handle" src="'+STRIVE_DATA.plugin_url+'img/drag-handle.svg" />')),e?e.parent().after(a):t.prev().append(a),a.find(".instructions-input").focus()}$("body").on("click",".add-item",(function(e){e.preventDefault(),t($(this))})),$("#strive-post-checklists form").keypress((function(e){if(13==e.which)if(e.preventDefault(),$(":focus").hasClass("add-item"))t($(":focus"));else if($(":focus").hasClass("instructions-input")){t($(":focus").parents(".task-container").siblings(".add-item"),$(":focus"))}}));var e=!1;$(window).bind("beforeunload",(function(){if(e)return"You have unsaved changes"})),$("#save-checklists").on("click",(function(){e=!1})),$("body").on("input",".instructions-input",(function(){!function(t){let e=t.val().replace("~","");""==e?t.siblings(".save-input").val(""):(e+="~"+t.next().val(),t.siblings(".save-input").val(e))}($(this)),e=!0})),$("body").on("click",".remove-item",(function(t){!function(t,e){t.preventDefault(),e.prev("input").val("").attr("type","hidden"),e.parent().hide()}(t,$(this)),e=!0}));var n=document.querySelectorAll(".task-container");n=Array.prototype.slice.call(n);var i="",s=dragula({containers:n,mirrorContainer:document.getElementById("strive-post-checklists"),moves:function(t,e,n){return n.classList.contains("drag-handle")}}).on("drag",(function(t,e){i=e.dataset.status,checklistIndex=e.dataset.checklist})).on("drop",(function(t,n){e=!0;let s=$(t).find(".save-input"),a=s.attr("id").replace(i,n.dataset.status),c=0;$(n).find(".task").each((function(){if($(this)[0]!=$(t)[0]){var e=parseInt($(this).attr("data-key"));c<=e&&(c=e+1)}})),a=a.substring(0,a.lastIndexOf("[")),a=a+"["+c+"]",s.attr("id",a).attr("name",a),t.dataset.key=c}));function a(){$("#loading").css("display","flex");let t=0;$(".checklist-container").each((function(){let e=$(this).attr("data-index");e>=t&&(t=parseInt(e)+1)}));var e={action:"get_the_checklist",index:t,get_the_checklist_nonce:STRIVE_DATA.get_the_checklist_nonce};jQuery.post(ajaxurl,e,(function(t){$("#loading").css("display","none"),t=JSON.parse(t),$(".checklist-container.current").removeClass("current"),$("#checklist-tabs").find(".tab.current").removeClass("current"),$("#checklist-tabs").append(t.tab),$("#checklists").append(t.checklist),r();let e='<option value="'+$(".tab.current").attr("data-id")+'">'+$(".tab.current").text()+"</option>";$("#strive_default_checklist").append(e);let n=$(".checklist-container.current .checklist-title"),i=n.val().length;n[0].focus(),n[0].setSelectionRange(i,i)}))}function c(t,e){t.preventDefault(),$("#checklist-tabs").find(".tab.current").removeClass("current"),e.addClass("current");const n=e.attr("data-id");$(".checklist-container").each((function(){$(this).attr("data-id")==n?$(this).addClass("current"):$(this).removeClass("current")}))}function r(){let t=document.querySelectorAll(".task-container");t=Array.prototype.slice.call(t),s.containers=t}$("#create-checklist").on("click",(function(t){t.preventDefault(),a()})),$("body").on("click",".tab",(function(t){c(t,$(this))})),$("body").on("input",".checklist-title",(function(){$(".tab.current").text($(this).val());let t=$(".tab.current").attr("data-id");$('#strive_default_checklist option[value="'+t+'"]').text($(this).val())})),$("body").on("click",".delete-button",(function(t){!function(t){if(t.preventDefault(),confirm("Are you sure you want to delete this checklist?")){let n=$(".checklist-container.current").attr("data-id");$(".checklist-container.current").remove(),$(".tab.current").remove(),0==$("#checklists").children().length&&a(),c(t,$("#checklist-tabs a").first()),$('#strive_default_checklist option[value="'+n+'"]').remove(),e=!0}}(t)})),function(){if(0==$("#strive_default_checklist option").length){let t='<option value="'+$(".tab.current").data("id")+'" selected>'+$(".tab.current").text()+"</option>";$("#strive_default_checklist").append(t)}}(),$("body").on("click",".export-button",(function(t){t.preventDefault();var e={action:"export_checklist",index:$(".checklist-container.current").attr("data-index"),export_checklist_nonce:STRIVE_DATA.export_checklist_nonce};$("#loading").css("display","flex"),jQuery.post(ajaxurl,e,(function(t){if($("#loading").css("display","none"),0==t.success)alert(t.data);else{var e=$(".tab.current").text()+".json",n=document.createElement("a"),i=new Blob([t],{type:"application/json"});n.href=URL.createObjectURL(i),n.download=e,n.click()}}))})),$("body").on("click",".import-button",(function(t){t.preventDefault(),$(this).next(".import-file").click()})),$("body").on("change",".import-file",(function(){const t=$(this);if(""==t.val())return;let e=$(".checklist-container.current"),n=e.attr("data-index"),i=e.attr("data-id"),s=e.find(".checklist-title").val(),a=t[0].files[0],c=new FileReader;c.readAsText(a),c.onload=function(){var e={action:"import_checklist",index:n,checklist_id:i,checklist_title:s,checklist_tasks:c.result,import_checklist_nonce:STRIVE_DATA.import_checklist_nonce};$("#loading").css("display","flex"),jQuery.post(ajaxurl,e,(function(e){$("#loading").css("display","none"),0==e.success?alert(e.data):($(".checklist-container.current").replaceWith(e),r()),t.val(null)}))},c.onerror=function(){console.log(c.error)}})),$("#settings-button, #close-settings").on("click",(function(t){t.preventDefault(),$("#strive-settings-container").toggleClass("visible")})),$("#save-checklists-settings").on("click",(function(){$("#strive-checklist-settings").addClass("saving")})),$("#strive-checklist-settings").on("submit",(function(t){t.preventDefault(),$(this).addClass("saving");var e={action:"save_checklist_settings",form_data:$(this).serialize(),save_checklist_settings_nonce:STRIVE_DATA.save_checklist_settings_nonce};jQuery.post(ajaxurl,e,(function(){$("#strive-settings-container").removeClass("visible"),$("#strive-checklist-settings").removeClass("saving")}))}));var o,l=document.querySelectorAll(".checklist-tabs");l=Array.prototype.slice.call(l),dragula({containers:l,mirrorContainer:document.getElementById("strive-post-checklists"),direction:"horizontal",axis:"x"}).on("drag",(function(t){o=$(t).index(),$(".tab.gu-mirror").css("top","200px !important")})).on("drop",(function(t){var e=!0;o<$(t).index()&&(e=!1),function(t,e,n){var i=$('.checklist-container[data-id="'+t+'"]'),s=$("#checklists .checklist-container").eq(e);n?s.before(i):s.after(i)}($(t).data("id"),$(t).index(),e)}))}));